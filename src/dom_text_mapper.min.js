(function(){window.DomTextMapper=function(){function t(){this.setRealRoot(),window.DomTextMapper.instances.push(this)}var e,o,n,r,i,s,a;return s=!0,i=!0,r=!0,o=!0,n=!0,e=32,t.instances=[],t.changed=function(t,e){var o,n,r,i;if(null==e&&(e="no reason"),0!==this.instances.length){for(i=this.instances,n=0,r=i.length;r>n;n++)o=i[n],o.performUpdateOnNode(t);return null}},t.prototype.setRootNode=function(t){return this.rootWin=window,this.pathStartNode=this.rootNode=t},t.prototype.setRootId=function(t){return this.setRootNode(document.getElementById(t))},t.prototype.setRootIframe=function(t){var e;if(e=window.document.getElementById(t),null==e)throw Error("Can't find iframe with specified ID!");if(this.rootWin=e.contentWindow,null==this.rootWin)throw Error("Can't access contents of the spefified iframe!");return this.rootNode=this.rootWin.document,this.pathStartNode=this.getBody()},t.prototype.getDefaultPath=function(){return this.getPathTo(this.pathStartNode)},t.prototype.setRealRoot=function(){return this.rootWin=window,this.rootNode=document,this.pathStartNode=this.getBody()},t.prototype.documentChanged=function(){return this.lastDOMChange=this.timestamp()},t.prototype.scan=function(){var t,e,o,n,r;return this.domStableSince(this.lastScanned)?this.path:(o=this.timestamp(),this.saveSelection(),this.path={},this.traverseSubTree(this.pathStartNode,this.getDefaultPath()),n=this.timestamp(),e=this.getPathTo(this.pathStartNode),t=this.path[e].node,this.collectPositions(t,e,null,0,0),this.restoreSelection(),this.lastScanned=this.timestamp(),this.corpus=this.path[e].content,r=this.timestamp(),this.path)},t.prototype.selectPath=function(t,e){var o,n;if(null==e&&(e=!1),o=this.path[t],null==o)throw Error("I have no info about a node at "+t);return n=null!=o?o.node:void 0,n||(n=this.lookUpNode(o.path)),this.selectNode(n,e)},t.prototype.performUpdateOnNode=function(t,e){var o,n,r,i,s,a,l,h,d,c,u,p,g,f;if(null==e&&(e=!1),null==t)throw Error("Called performUpdate with a null node!");if(null!=this.path){if(u=this.timestamp(),e||this.saveSelection(),l=this.getPathTo(t),h=this.path[l],null==h)return this.performUpdateOnNode(t.parentNode,!0),e||this.restoreSelection(),void 0;if(h.node===t&&h.content===this.getNodeContent(t,!1)){c=l+"/",d=r,d=[],f=this.path;for(r in f)o=f[r],this.stringStartsWith(r,c)&&d.push(r);for(p=0,g=d.length;g>p;p++)r=d[p],delete this.path[r];if(this.traverseSubTree(t,l),h.node===this.pathStartNode)console.log("Ended up rescanning the whole doc."),this.collectPositions(t,l,null,0,0);else{if(s=this.parentPath(l),a=this.path[s],null==a)throw Error("While performing update on node "+l+", no path info found for parent path: "+s);n=t===t.parentNode.firstChild?0:this.path[this.getPathTo(t.previousSibling)].end-a.start,this.collectPositions(t,l,a.content,a.start,n)}}else{if(h.node===this.pathStartNode)throw Error("Can not keep up with the changes, since even the node configured as path start node was replaced.");i=null!=t.parentNode?t.parentNode:(s=this.parentPath(l),this.lookUpNode(s)),this.performUpdateOnNode(i,!0)}return e?void 0:this.restoreSelection()}},t.prototype.getInfoForPath=function(t){var e;if(null==this.path)throw Error("Can't get info before running a scan() !");if(e=this.path[t],null==e)throw Error("Found no info for path '"+t+"'!");return e},t.prototype.getInfoForNode=function(t){return this.getInfoForPath(this.getPathTo(t))},t.prototype.getMappingsForCharRanges=function(t){var e,o,n,r,i;for(i=[],n=0,r=t.length;r>n;n++)e=t[n],i.push(o=this.getMappingsForCharRange(e.start,e.end));return i},t.prototype.getContentForPath=function(t){return null==t&&(t=null),null==t&&(t=this.getDefaultPath()),this.path[t].content},t.prototype.getLengthForPath=function(t){return null==t&&(t=null),null==t&&(t=this.getDefaultPath()),this.path[t].length},t.prototype.getDocLength=function(){return this.getLengthForPath()},t.prototype.getContentForCharRange=function(t,e,o){var n;return null==o&&(o=null),n=this.getContentForPath(o).substr(t,e-t),n.trim()},t.prototype.getContextForCharRange=function(t,o,n){var r,i,s,a,l;return null==n&&(n=null),r=this.getContentForPath(n),a=Math.max(0,t-e),s=t-a,i=r.substr(a,s),l=r.substr(o,s),[i.trim(),l.trim()]},t.prototype.getMappingsForCharRange=function(t,e){var o,n,r,i,s,a,l,h,d,c,u,p,g,f,m,N,S=this;if(null==t||null==e)throw Error("start and end is required!");this.scan(),l=[],N=this.path;for(h in N)a=N[h],a.atomic&&this.regions_overlap(a.start,a.end,t,e)&&function(o){var n,r;return r={element:o},n=o.start>=t&&e>=o.end,n?(r.full=!0,r.wanted=o.content,r.yields=o.content,r.startCorrected=0,r.endCorrected=0):o.node.nodeType===Node.TEXT_NODE?(o.start>=t?(r.end=e-o.start,r.wanted=o.content.substr(0,r.end)):e>=o.end?(r.start=t-o.start,r.wanted=o.content.substr(r.start)):(r.start=t-o.start,r.end=e-o.start,r.wanted=o.content.substr(r.start,r.end-r.start)),S.computeSourcePositions(r),r.yields=o.node.data.substr(r.startCorrected,r.endCorrected-r.startCorrected)):o.node.nodeType===Node.ELEMENT_NODE&&"img"===o.node.tagName.toLowerCase()?(console.log("Can not select a sub-string from the title of an image. Selecting all."),r.full=!0,r.wanted=o.content):(console.log("Warning: no idea how to handle partial mappings for node type "+o.node.nodeType),null!=o.node.tagName&&console.log("Tag: "+o.node.tagName),console.log("Selecting all."),r.full=!0,r.wanted=o.content),l.push(r)}(a);if(0===l.length)throw Error("No mappings found for ["+t+":"+e+"]!");return d=this.rootWin.document.createRange(),p=l[0],g=p.element.node,m=p.element.path,f=p.startCorrected,p.full?(d.setStartBefore(g),u=m):(d.setStart(g,f),u=m+":"+f),n=l[l.length-1],r=n.element.node,s=n.element.path,i=n.endCorrected,n.full?(d.setEndAfter(r),o=s):(d.setEnd(r,i),o=s+":"+i),c={mappings:l,realRange:d,rangeInfo:{startPath:m,startOffset:f,startInfo:u,endPath:s,endOffset:i,endInfo:o},safeParent:d.commonAncestorContainer}},t.prototype.timestamp=function(){return(new Date).getTime()},t.prototype.stringStartsWith=function(t,e){return e===t.substr(0,e.length)},t.prototype.stringEndsWith=function(t,e){return e===t.substr(t.length-e.length)},t.prototype.parentPath=function(t){return t.substr(0,t.lastIndexOf("/"))},t.prototype.domChangedSince=function(t){return null!=this.lastDOMChange&&null!=t?this.lastDOMChange>t:!0},t.prototype.domStableSince=function(t){return!this.domChangedSince(t)},t.prototype.getProperNodeName=function(t){var e;switch(e=t.nodeName){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return e}},t.prototype.getNodePosition=function(t){var e,o;for(e=0,o=t;o;)o.nodeName===t.nodeName&&e++,o=o.previousSibling;return e},t.prototype.getPathSegment=function(t){var e,o;return e=this.getProperNodeName(t),o=this.getNodePosition(t),e+(o>1?"["+o+"]":"")},t.prototype.getPathTo=function(t){var e;for(e="";t!==this.rootNode;)e=this.getPathSegment(t)+"/"+e,t=t.parentNode;return e=(null!=this.rootNode.ownerDocument?"./":"/")+e,e=e.replace(/\/$/,"")},t.prototype.traverseSubTree=function(t,e,o,n){var r,i,s,a,l,h;if(null==o&&(o=!1),null==n&&(n=!1),this.underTraverse=e,i=this.getNodeContent(t,!1),this.path[e]={path:e,content:i,length:i.length,node:t},i.length?(n&&console.log("Collected info about path "+e),o&&console.log("Something seems to be wrong. I see visible content @ "+e+", while some of the ancestor nodes reported empty contents. Probably a new selection API bug....")):(n&&console.log("Found no content at path "+e),o=!0),t.hasChildNodes())for(h=t.childNodes,a=0,l=h.length;l>a;a++)r=h[a],s=e+"/"+this.getPathSegment(r),this.traverseSubTree(r,s,o,n);return null},t.prototype.getBody=function(){return this.rootWin.document.getElementsByTagName("body")[0]},t.prototype.regions_overlap=function(t,e,o,n){return n>t&&e>o},t.prototype.lookUpNode=function(t){var e,o,n,r;return e=null!=(r=this.rootNode.ownerDocument)?r:this.rootNode,n=e.evaluate(t,this.rootNode,null,0,null),o=n.iterateNext()},t.prototype.saveSelection=function(){var t,e,o,n,r;if(null!=this.savedSelection)throw console.log("Selection saved at:"),console.log(this.selectionSaved),Error("Selection already saved!");for(e=this.rootWin.getSelection(),t=o=0,n=e.rangeCount;n>=0?n>o:o>n;t=n>=0?++o:--o)this.savedSelection=e.getRangeAt(t);switch(e.rangeCount){case 0:null==(r=this.savedSelection)&&(this.savedSelection=[]);break;case 1:this.savedSelection=[this.savedSelection]}try{throw Error("Selection was saved here")}catch(i){return this.selectionSaved=i.stack}},t.prototype.restoreSelection=function(){var t,e,o,n,r;if(null==this.savedSelection)throw Error("No selection to restore.");for(e=this.rootWin.getSelection(),e.removeAllRanges(),r=this.savedSelection,o=0,n=r.length;n>o;o++)t=r[o],e.addRange(t);return delete this.savedSelection},t.prototype.selectNode=function(t,e){var a,l,h,d,c;if(null==e&&(e=!1),null==t)throw Error("Called selectNode with null node!");if(h=this.rootWin.getSelection(),h.removeAllRanges(),l=this.rootWin.document.createRange(),t.nodeType===Node.ELEMENT_NODE&&t.hasChildNodes()&&(s&&("thead"===(c=t.tagName.toLowerCase())||"tbody"===c)||r&&"ol"===t.tagName.toLowerCase()||o&&"caption"===t.tagName.toLowerCase()))a=t.childNodes,l.setStartBefore(a[0]),l.setEndAfter(a[a.length-1]),h.addRange(l);else if(i&&t.nodeType===Node.TEXT_NODE&&"table"===t.parentNode.tagName.toLowerCase());else try{l.setStartBefore(t),l.setEndAfter(t),h.addRange(l)}catch(u){n&&this.isWhitespace(t)||(console.log("Warning: failed to scan element @ "+this.underTraverse),console.log("Content is: "+t.innerHTML),console.log("We won't be able to properly anchor to any text inside this element."))}if(e){for(d=t;null!=d&&null==d.scrollIntoViewIfNeeded;)d=d.parentNode;null!=d?d.scrollIntoViewIfNeeded():console.log("Failed to scroll to element. (Browser does not support scrollIntoViewIfNeeded?)")}return h},t.prototype.readSelectionText=function(t){return t||(t=this.rootWin.getSelection()),(""+t).trim().replace(/\n/g," ").replace(/\s{2,}/g," ")},t.prototype.getNodeSelectionText=function(t,e){var o,n;return null==e&&(e=!0),e&&this.saveSelection(),o=this.selectNode(t),n=this.readSelectionText(o),e&&this.restoreSelection(),n},t.prototype.computeSourcePositions=function(t){var e,o,n,r,i,s,a,l,h,d;if(d=t.element.node.data.replace(/\n/g," "),i=t.element.content,r=null!=t.start?t.start:0,o=null!=t.end?t.end:i.length,0===o)return t.startCorrected=0,t.endCorrected=0,void 0;for(l=0,n=0;null==h||null==a;)s=d[l],e=i[n],s===e&&(n===r&&(h=l),n++,n===o&&(a=l+1)),l++;return t.startCorrected=h,t.endCorrected=a,null},t.prototype.getNodeContent=function(t,e){return null==e&&(e=!0),this.getNodeSelectionText(t,e)},t.prototype.collectPositions=function(t,e,o,n,r){var i,s,a,l,h,d,c,u,p,g,f,m,N,S;if(null==o&&(o=null),null==n&&(n=0),null==r&&(r=0),f=this.path[e],h=null!=f?f.content:void 0,null==h||""===h)return f.start=n+r,f.end=n+r,f.atomic=!1,r;if(N=null!=o?o.indexOf(h,r):r,-1===N)return r;if(d=N+h.length,i=!t.hasChildNodes(),f.start=n+N,f.end=n+d,f.atomic=i,!i)for(l=t.childNodes,c=0,m=0,S={};l.length>c;)s=l[c],p=this.getProperNodeName(s),g=S[p],u=null!=g?g+1:1,S[p]=u,a=e+"/"+p+(u>1?"["+u+"]":""),m=this.collectPositions(s,a,h,n+N,m),c++;return d},a=/^\s*$/,t.prototype.isWhitespace=function(t){var e,o,n;return n=function(){var n,r,i;switch(t.nodeType){case Node.TEXT_NODE:return a.test(t.data);case Node.ELEMENT_NODE:for(o=!0,i=t.childNodes,n=0,r=i.length;r>n;n++)e=i[n],o=o&&this.isWhitespace(e);return o;default:return!1}}.call(this)},t}()}).call(this);
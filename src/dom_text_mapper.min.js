(function(){var t=[].indexOf||function(t){for(var e=0,o=this.length;o>e;e++)if(e in this&&this[e]===t)return e;return-1};window.DomTextMapper=function(){function e(){this.setRealRoot(),window.DomTextMapper.instances.push(this)}var o,n,r,i,s;return i=!0,r=!0,n=["thead","tbody","ol","a","caption","p"],o=32,e.instances=[],e.changed=function(t,e){var o,n,r,i;if(null==e&&(e="no reason"),0!==this.instances.length){for(i=this.instances,n=0,r=i.length;r>n;n++)o=i[n],o.performUpdateOnNode(t);return null}},e.prototype.setRootNode=function(t){return this.rootWin=window,this.pathStartNode=this.rootNode=t},e.prototype.setRootId=function(t){return this.setRootNode(document.getElementById(t))},e.prototype.setRootIframe=function(t){var e;if(e=window.document.getElementById(t),null==e)throw Error("Can't find iframe with specified ID!");if(this.rootWin=e.contentWindow,null==this.rootWin)throw Error("Can't access contents of the spefified iframe!");return this.rootNode=this.rootWin.document,this.pathStartNode=this.getBody()},e.prototype.getDefaultPath=function(){return this.getPathTo(this.pathStartNode)},e.prototype.setRealRoot=function(){return this.rootWin=window,this.rootNode=document,this.pathStartNode=this.getBody()},e.prototype.documentChanged=function(){return this.lastDOMChange=this.timestamp()},e.prototype.scan=function(){var t,e,o,n,r;return this.domStableSince(this.lastScanned)?this.path:(o=this.timestamp(),this.saveSelection(),this.path={},this.traverseSubTree(this.pathStartNode,this.getDefaultPath()),n=this.timestamp(),e=this.getPathTo(this.pathStartNode),t=this.path[e].node,this.collectPositions(t,e,null,0,0),this.restoreSelection(),this.lastScanned=this.timestamp(),this.corpus=this.path[e].content,r=this.timestamp(),this.path)},e.prototype.selectPath=function(t,e){var o,n;if(null==e&&(e=!1),o=this.path[t],null==o)throw Error("I have no info about a node at "+t);return n=null!=o?o.node:void 0,n||(n=this.lookUpNode(o.path)),this.selectNode(n,e)},e.prototype.performUpdateOnNode=function(t,e){var o,n,r,i,s,a,l,h,d,u,c,p,f,g;if(null==e&&(e=!1),null==t)throw Error("Called performUpdate with a null node!");if(null!=this.path){if(c=this.timestamp(),e||this.saveSelection(),l=this.getPathTo(t),h=this.path[l],null==h)return this.performUpdateOnNode(t.parentNode,!0),e||this.restoreSelection(),void 0;if(h.node===t&&h.content===this.getNodeContent(t,!1)){u=l+"/",d=r,d=[],g=this.path;for(r in g)o=g[r],this.stringStartsWith(r,u)&&d.push(r);for(p=0,f=d.length;f>p;p++)r=d[p],delete this.path[r];if(this.traverseSubTree(t,l),h.node===this.pathStartNode)console.log("Ended up rescanning the whole doc."),this.collectPositions(t,l,null,0,0);else{if(s=this.parentPath(l),a=this.path[s],null==a)throw Error("While performing update on node "+l+", no path info found for parent path: "+s);n=t===t.parentNode.firstChild?0:this.path[this.getPathTo(t.previousSibling)].end-a.start,this.collectPositions(t,l,a.content,a.start,n)}}else{if(h.node===this.pathStartNode)throw Error("Can not keep up with the changes, since even the node configured as path start node was replaced.");i=null!=t.parentNode?t.parentNode:(s=this.parentPath(l),this.lookUpNode(s)),this.performUpdateOnNode(i,!0)}return e?void 0:this.restoreSelection()}},e.prototype.getInfoForPath=function(t){var e;if(null==this.path)throw Error("Can't get info before running a scan() !");if(e=this.path[t],null==e)throw Error("Found no info for path '"+t+"'!");return e},e.prototype.getInfoForNode=function(t){return this.getInfoForPath(this.getPathTo(t))},e.prototype.getMappingsForCharRanges=function(t){var e,o,n,r,i;for(i=[],n=0,r=t.length;r>n;n++)e=t[n],i.push(o=this.getMappingsForCharRange(e.start,e.end));return i},e.prototype.getContentForPath=function(t){return null==t&&(t=null),null==t&&(t=this.getDefaultPath()),this.path[t].content},e.prototype.getLengthForPath=function(t){return null==t&&(t=null),null==t&&(t=this.getDefaultPath()),this.path[t].length},e.prototype.getDocLength=function(){return this.getLengthForPath()},e.prototype.getContentForCharRange=function(t,e,o){var n;return null==o&&(o=null),n=this.getContentForPath(o).substr(t,e-t),n.trim()},e.prototype.getContextForCharRange=function(t,e,n){var r,i,s,a,l;return null==n&&(n=null),r=this.getContentForPath(n),a=Math.max(0,t-o),s=t-a,i=r.substr(a,s),l=r.substr(e,s),[i.trim(),l.trim()]},e.prototype.getMappingsForCharRange=function(t,e){var o,n,r,i,s,a,l,h,d,u,c,p,f,g,m,N,v=this;if(null==t||null==e)throw Error("start and end is required!");this.scan(),l=[],N=this.path;for(h in N)a=N[h],a.atomic&&this.regions_overlap(a.start,a.end,t,e)&&function(o){var n,r;return r={element:o},n=o.start>=t&&e>=o.end,n?(r.full=!0,r.wanted=o.content,r.yields=o.content,r.startCorrected=0,r.endCorrected=0):o.node.nodeType===Node.TEXT_NODE?(o.start>=t?(r.end=e-o.start,r.wanted=o.content.substr(0,r.end)):e>=o.end?(r.start=t-o.start,r.wanted=o.content.substr(r.start)):(r.start=t-o.start,r.end=e-o.start,r.wanted=o.content.substr(r.start,r.end-r.start)),v.computeSourcePositions(r),r.yields=o.node.data.substr(r.startCorrected,r.endCorrected-r.startCorrected)):o.node.nodeType===Node.ELEMENT_NODE&&"img"===o.node.tagName.toLowerCase()?(console.log("Can not select a sub-string from the title of an image. Selecting all."),r.full=!0,r.wanted=o.content):(console.log("Warning: no idea how to handle partial mappings for node type "+o.node.nodeType),null!=o.node.tagName&&console.log("Tag: "+o.node.tagName),console.log("Selecting all."),r.full=!0,r.wanted=o.content),l.push(r)}(a);if(0===l.length)throw Error("No mappings found for ["+t+":"+e+"]!");return d=this.rootWin.document.createRange(),p=l[0],f=p.element.node,m=p.element.path,g=p.startCorrected,p.full?(d.setStartBefore(f),c=m):(d.setStart(f,g),c=m+":"+g),n=l[l.length-1],r=n.element.node,s=n.element.path,i=n.endCorrected,n.full?(d.setEndAfter(r),o=s):(d.setEnd(r,i),o=s+":"+i),u={mappings:l,realRange:d,rangeInfo:{startPath:m,startOffset:g,startInfo:c,endPath:s,endOffset:i,endInfo:o},safeParent:d.commonAncestorContainer}},e.prototype.timestamp=function(){return(new Date).getTime()},e.prototype.stringStartsWith=function(t,e){return e===t.substr(0,e.length)},e.prototype.stringEndsWith=function(t,e){return e===t.substr(t.length-e.length)},e.prototype.parentPath=function(t){return t.substr(0,t.lastIndexOf("/"))},e.prototype.domChangedSince=function(t){return null!=this.lastDOMChange&&null!=t?this.lastDOMChange>t:!0},e.prototype.domStableSince=function(t){return!this.domChangedSince(t)},e.prototype.getProperNodeName=function(t){var e;switch(e=t.nodeName){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return e}},e.prototype.getNodePosition=function(t){var e,o;for(e=0,o=t;o;)o.nodeName===t.nodeName&&e++,o=o.previousSibling;return e},e.prototype.getPathSegment=function(t){var e,o;return e=this.getProperNodeName(t),o=this.getNodePosition(t),e+(o>1?"["+o+"]":"")},e.prototype.getPathTo=function(t){var e;for(e="";t!==this.rootNode;)e=this.getPathSegment(t)+"/"+e,t=t.parentNode;return e=(null!=this.rootNode.ownerDocument?"./":"/")+e,e=e.replace(/\/$/,"")},e.prototype.traverseSubTree=function(t,e,o,n){var r,i,s,a,l,h;if(null==o&&(o=!1),null==n&&(n=!1),this.underTraverse=e,i=this.getNodeContent(t,!1),this.path[e]={path:e,content:i,length:i.length,node:t},i.length?(n&&console.log("Collected info about path "+e),o&&console.log("Something seems to be wrong. I see visible content @ "+e+", while some of the ancestor nodes reported empty contents. Probably a new selection API bug....")):(n&&console.log("Found no content at path "+e),o=!0),t.hasChildNodes())for(h=t.childNodes,a=0,l=h.length;l>a;a++)r=h[a],s=e+"/"+this.getPathSegment(r),this.traverseSubTree(r,s,o,n);return null},e.prototype.getBody=function(){return this.rootWin.document.getElementsByTagName("body")[0]},e.prototype.regions_overlap=function(t,e,o,n){return n>t&&e>o},e.prototype.lookUpNode=function(t){var e,o,n,r;return e=null!=(r=this.rootNode.ownerDocument)?r:this.rootNode,n=e.evaluate(t,this.rootNode,null,0,null),o=n.iterateNext()},e.prototype.saveSelection=function(){var t,e,o,n,r;if(null!=this.savedSelection)throw console.log("Selection saved at:"),console.log(this.selectionSaved),Error("Selection already saved!");for(e=this.rootWin.getSelection(),t=o=0,n=e.rangeCount;n>=0?n>o:o>n;t=n>=0?++o:--o)this.savedSelection=e.getRangeAt(t);switch(e.rangeCount){case 0:null==(r=this.savedSelection)&&(this.savedSelection=[]);break;case 1:this.savedSelection=[this.savedSelection]}try{throw Error("Selection was saved here")}catch(i){return this.selectionSaved=i.stack}},e.prototype.restoreSelection=function(){var t,e,o,n,r;if(null==this.savedSelection)throw Error("No selection to restore.");for(e=this.rootWin.getSelection(),e.removeAllRanges(),r=this.savedSelection,o=0,n=r.length;n>o;o++)t=r[o],e.addRange(t);return delete this.savedSelection},e.prototype.selectNode=function(e,o){var s,a,l,h,d;if(null==o&&(o=!1),null==e)throw Error("Called selectNode with null node!");if(l=this.rootWin.getSelection(),l.removeAllRanges(),a=this.rootWin.document.createRange(),e.nodeType===Node.ELEMENT_NODE&&e.hasChildNodes()&&(d=e.tagName.toLowerCase(),t.call(n,d)>=0))s=e.childNodes,a.setStartBefore(s[0]),a.setEndAfter(s[s.length-1]),l.addRange(a);else if(i&&e.nodeType===Node.TEXT_NODE&&"table"===e.parentNode.tagName.toLowerCase());else try{a.setStartBefore(e),a.setEndAfter(e),l.addRange(a)}catch(u){r&&this.isWhitespace(e)||(console.log("Warning: failed to scan element @ "+this.underTraverse),console.log("Content is: "+e.innerHTML),console.log("We won't be able to properly anchor to any text inside this element."))}if(o){for(h=e;null!=h&&null==h.scrollIntoViewIfNeeded;)h=h.parentNode;null!=h?h.scrollIntoViewIfNeeded():console.log("Failed to scroll to element. (Browser does not support scrollIntoViewIfNeeded?)")}return l},e.prototype.readSelectionText=function(t){return t||(t=this.rootWin.getSelection()),(""+t).trim().replace(/\n/g," ").replace(/\s{2,}/g," ")},e.prototype.getNodeSelectionText=function(t,e){var o,n;return null==e&&(e=!0),e&&this.saveSelection(),o=this.selectNode(t),n=this.readSelectionText(o),e&&this.restoreSelection(),n},e.prototype.computeSourcePositions=function(t){var e,o,n,r,i,s,a,l,h,d;if(d=t.element.node.data.replace(/\n/g," "),i=t.element.content,r=null!=t.start?t.start:0,o=null!=t.end?t.end:i.length,0===o)return t.startCorrected=0,t.endCorrected=0,void 0;for(l=0,n=0;null==h||null==a;)s=d[l],e=i[n],s===e&&(n===r&&(h=l),n++,n===o&&(a=l+1)),l++;return t.startCorrected=h,t.endCorrected=a,null},e.prototype.getNodeContent=function(t,e){return null==e&&(e=!0),this.getNodeSelectionText(t,e)},e.prototype.collectPositions=function(t,e,o,n,r){var i,s,a,l,h,d,u,c,p,f,g,m,N,v;if(null==o&&(o=null),null==n&&(n=0),null==r&&(r=0),g=this.path[e],h=null!=g?g.content:void 0,null==h||""===h)return g.start=n+r,g.end=n+r,g.atomic=!1,r;if(N=null!=o?o.indexOf(h,r):r,-1===N)return r;if(d=N+h.length,i=!t.hasChildNodes(),g.start=n+N,g.end=n+d,g.atomic=i,!i)for(l=t.childNodes,u=0,m=0,v={};l.length>u;)s=l[u],p=this.getProperNodeName(s),f=v[p],c=null!=f?f+1:1,v[p]=c,a=e+"/"+p+(c>1?"["+c+"]":""),m=this.collectPositions(s,a,h,n+N,m),u++;return d},s=/^\s*$/,e.prototype.isWhitespace=function(t){var e,o,n;return n=function(){var n,r,i;switch(t.nodeType){case Node.TEXT_NODE:return s.test(t.data);case Node.ELEMENT_NODE:for(o=!0,i=t.childNodes,n=0,r=i.length;r>n;n++)e=i[n],o=o&&this.isWhitespace(e);return o;default:return!1}}.call(this)},e}()}).call(this);
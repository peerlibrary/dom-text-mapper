(function(){window.DomTextMapper=function(){function t(){this.setRealRoot(),window.DomTextMapper.instances.push(this)}var e,o,n,r,i,a,s;return a=!0,i=!0,r=!0,o=!0,n=!0,e=32,t.instances=[],t.changed=function(t,e){var o,n,r,i;if(null==e&&(e="no reason"),0!==this.instances.length){for(i=this.instances,n=0,r=i.length;r>n;n++)o=i[n],o.performUpdateOnNode(t);return null}},t.prototype.setRootNode=function(t){return this.rootWin=window,this.pathStartNode=this.rootNode=t},t.prototype.setRootId=function(t){return this.setRootNode(document.getElementById(t))},t.prototype.setRootIframe=function(t){var e;if(e=window.document.getElementById(t),null==e)throw Error("Can't find iframe with specified ID!");if(this.rootWin=e.contentWindow,null==this.rootWin)throw Error("Can't access contents of the spefified iframe!");return this.rootNode=this.rootWin.document,this.pathStartNode=this.getBody()},t.prototype.getDefaultPath=function(){return this.getPathTo(this.pathStartNode)},t.prototype.setRealRoot=function(){return this.rootWin=window,this.rootNode=document,this.pathStartNode=this.getBody()},t.prototype.documentChanged=function(){return this.lastDOMChange=this.timestamp()},t.prototype.scan=function(){var t,e,o,n,r;return this.domStableSince(this.lastScanned)?this.path:(o=this.timestamp(),this.saveSelection(),this.path={},this.traverseSubTree(this.pathStartNode),n=this.timestamp(),e=this.getPathTo(this.pathStartNode),t=this.path[e].node,this.collectPositions(t,e,null,0,0),this.restoreSelection(),this.lastScanned=this.timestamp(),this.corpus=this.path[e].content,r=this.timestamp(),this.path)},t.prototype.selectPath=function(t,e){var o,n;if(null==e&&(e=!1),o=this.path[t],null==o)throw Error("I have no info about a node at "+t);return n=null!=o?o.node:void 0,n||(n=this.lookUpNode(o.path)),this.selectNode(n,e)},t.prototype.performUpdateOnNode=function(t,e){var o,n,r,i,a,s,l,h,d,c,u,p,f,g;if(null==e&&(e=!1),null==t)throw Error("Called performUpdate with a null node!");if(null!=this.path){if(u=this.timestamp(),e||this.saveSelection(),l=this.getPathTo(t),h=this.path[l],null==h)return this.performUpdateOnNode(t.parentNode,!0),e||this.restoreSelection(),void 0;if(h.node===t&&h.content===this.getNodeContent(t,!1)){c=l+"/",d=r,d=[],g=this.path;for(r in g)o=g[r],this.stringStartsWith(r,c)&&d.push(r);for(p=0,f=d.length;f>p;p++)r=d[p],delete this.path[r];if(this.traverseSubTree(t),h.node===this.pathStartNode)console.log("Ended up rescanning the whole doc."),this.collectPositions(t,l,null,0,0);else{if(a=this.parentPath(l),s=this.path[a],null==s)throw Error("While performing update on node "+l+", no path info found for parent path: "+a);n=t===t.parentNode.firstChild?0:this.path[this.getPathTo(t.previousSibling)].end-s.start,this.collectPositions(t,l,s.content,s.start,n)}}else{if(h.node===this.pathStartNode)throw console.log("I can not go up, since I'm already at path start node. Barking out."),Error("Can not keep up with the changes, since even the node configured as path start node was replaced.");i=null!=t.parentNode?t.parentNode:(a=this.parentPath(l),this.lookUpNode(a)),this.performUpdateOnNode(i,!0)}return e?void 0:this.restoreSelection()}},t.prototype.getInfoForPath=function(t){var e;if(null==this.path)throw Error("Can't get info before running a scan() !");if(e=this.path[t],null==e)throw Error("Found no info for path '"+t+"'!");return e},t.prototype.getInfoForNode=function(t){return this.getInfoForPath(this.getPathTo(t))},t.prototype.getMappingsForCharRanges=function(t){var e,o,n,r,i;for(i=[],n=0,r=t.length;r>n;n++)e=t[n],i.push(o=this.getMappingsForCharRange(e.start,e.end));return i},t.prototype.getContentForPath=function(t){return null==t&&(t=null),null==t&&(t=this.getDefaultPath()),this.path[t].content},t.prototype.getLengthForPath=function(t){return null==t&&(t=null),null==t&&(t=this.getDefaultPath()),this.path[t].length},t.prototype.getDocLength=function(){return this.getLengthForPath()},t.prototype.getContentForCharRange=function(t,e,o){var n;return null==o&&(o=null),n=this.getContentForPath(o).substr(t,e-t),n.trim()},t.prototype.getContextForCharRange=function(t,o,n){var r,i,a,s,l;return null==n&&(n=null),r=this.getContentForPath(n),s=Math.max(0,t-e),a=t-s,i=r.substr(s,a),l=r.substr(o,a),[i.trim(),l.trim()]},t.prototype.getMappingsForCharRange=function(t,e){var o,n,r,i,a,s,l,h,d,c,u,p,f,g,m,N,S=this;if(null==t||null==e)throw Error("start and end is required!");this.scan(),l=[],N=this.path;for(h in N)s=N[h],s.atomic&&this.regions_overlap(s.start,s.end,t,e)&&function(o){var n,r;return r={element:o},n=o.start>=t&&e>=o.end,n?(r.full=!0,r.wanted=o.content,r.yields=o.content,r.startCorrected=0,r.endCorrected=0):o.node.nodeType===Node.TEXT_NODE?(o.start>=t?(r.end=e-o.start,r.wanted=o.content.substr(0,r.end)):e>=o.end?(r.start=t-o.start,r.wanted=o.content.substr(r.start)):(r.start=t-o.start,r.end=e-o.start,r.wanted=o.content.substr(r.start,r.end-r.start)),S.computeSourcePositions(r),r.yields=o.node.data.substr(r.startCorrected,r.endCorrected-r.startCorrected)):o.node.nodeType===Node.ELEMENT_NODE&&"img"===o.node.tagName.toLowerCase()?(console.log("Can not select a sub-string from the title of an image. Selecting all."),r.full=!0,r.wanted=o.content):(console.log("Warning: no idea how to handle partial mappings for node type "+o.node.nodeType),null!=o.node.tagName&&console.log("Tag: "+o.node.tagName),console.log("Selecting all."),r.full=!0,r.wanted=o.content),l.push(r)}(s);if(0===l.length)throw Error("No mappings found for ["+t+":"+e+"]!");return d=this.rootWin.document.createRange(),p=l[0],f=p.element.node,m=p.element.path,g=p.startCorrected,p.full?(d.setStartBefore(f),u=m):(d.setStart(f,g),u=m+":"+g),n=l[l.length-1],r=n.element.node,a=n.element.path,i=n.endCorrected,n.full?(d.setEndAfter(r),o=a):(d.setEnd(r,i),o=a+":"+i),c={mappings:l,realRange:d,rangeInfo:{startPath:m,startOffset:g,startInfo:u,endPath:a,endOffset:i,endInfo:o},safeParent:d.commonAncestorContainer}},t.prototype.timestamp=function(){return(new Date).getTime()},t.prototype.stringStartsWith=function(t,e){return e===t.substr(0,e.length)},t.prototype.stringEndsWith=function(t,e){return e===t.substr(t.length-e.length)},t.prototype.parentPath=function(t){return t.substr(0,t.lastIndexOf("/"))},t.prototype.domChangedSince=function(t){return null!=this.lastDOMChange&&null!=t?this.lastDOMChange>t:!0},t.prototype.domStableSince=function(t){return!this.domChangedSince(t)},t.prototype.getProperNodeName=function(t){var e;switch(e=t.nodeName){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return e}},t.prototype.getPathTo=function(t){var e,o,n;for(n="";t!==this.rootNode;){for(e=0,o=t;o;)o.nodeName===t.nodeName&&e++,o=o.previousSibling;n=this.getProperNodeName(t)+(e>1?"["+e+"]":"")+"/"+n,t=t.parentNode}return n=(null!=this.rootNode.ownerDocument?"./":"/")+n,n=n.replace(/\/$/,"")},t.prototype.traverseSubTree=function(t,e,o){var n,r,i,a,s,l;if(null==e&&(e=!1),null==o&&(o=!1),i=this.getPathTo(t),r=this.getNodeContent(t,!1),this.path[i]={path:i,content:r,length:r.length,node:t},r.length?(o&&console.log("Collected info about path "+i),e&&console.log("Something seems to be wrong. I see visible content @ "+i+", while some of the ancestor nodes reported empty contents. Probably a new selection API bug....")):(o&&console.log("Found no content at path "+i),e=!0),t.hasChildNodes())for(l=t.childNodes,a=0,s=l.length;s>a;a++)n=l[a],this.traverseSubTree(n,e,o);return null},t.prototype.getBody=function(){return this.rootWin.document.getElementsByTagName("body")[0]},t.prototype.regions_overlap=function(t,e,o,n){return n>t&&e>o},t.prototype.lookUpNode=function(t){var e,o,n,r;return e=null!=(r=this.rootNode.ownerDocument)?r:this.rootNode,n=e.evaluate(t,this.rootNode,null,0,null),o=n.iterateNext()},t.prototype.saveSelection=function(){var t,e,o,n,r;if(null!=this.savedSelection)throw console.log("Selection saved at:"),console.log(this.selectionSaved),Error("Selection already saved!");for(e=this.rootWin.getSelection(),t=o=0,n=e.rangeCount;n>=0?n>o:o>n;t=n>=0?++o:--o)this.savedSelection=e.getRangeAt(t);switch(e.rangeCount){case 0:null==(r=this.savedSelection)&&(this.savedSelection=[]);break;case 1:this.savedSelection=[this.savedSelection]}try{throw Error("Selection was saved here")}catch(i){return this.selectionSaved=i.stack}},t.prototype.restoreSelection=function(){var t,e,o,n,r;if(null==this.savedSelection)throw Error("No selection to restore.");for(e=this.rootWin.getSelection(),e.removeAllRanges(),r=this.savedSelection,o=0,n=r.length;n>o;o++)t=r[o],e.addRange(t);return delete this.savedSelection},t.prototype.selectNode=function(t,e){var s,l,h,d,c;if(null==e&&(e=!1),h=this.rootWin.getSelection(),h.removeAllRanges(),l=this.rootWin.document.createRange(),t.nodeType===Node.ELEMENT_NODE&&t.hasChildNodes()&&(a&&("thead"===(c=t.tagName.toLowerCase())||"tbody"===c)||r&&"ol"===t.tagName.toLowerCase()||o&&"caption"===t.tagName.toLowerCase()))s=t.childNodes,l.setStartBefore(s[0]),l.setEndAfter(s[s.length-1]),h.addRange(l);else if(i&&t.nodeType===Node.TEXT_NODE&&"table"===t.parentNode.tagName.toLowerCase());else try{l.setStartBefore(t),l.setEndAfter(t),h.addRange(l)}catch(u){if(!n||!this.isWhitespace(t))throw u}if(e){for(d=t;null==d.scrollIntoViewIfNeeded;)d=d.parentNode;d.scrollIntoViewIfNeeded()}return h},t.prototype.readSelectionText=function(t){return t||(t=this.rootWin.getSelection()),(""+t).trim().replace(/\n/g," ").replace(/\s{2,}/g," ")},t.prototype.getNodeSelectionText=function(t,e){var o,n;return null==e&&(e=!0),e&&this.saveSelection(),o=this.selectNode(t),n=this.readSelectionText(o),e&&this.restoreSelection(),n},t.prototype.computeSourcePositions=function(t){var e,o,n,r,i,a,s,l,h,d;if(d=t.element.node.data.replace(/\n/g," "),i=t.element.content,r=null!=t.start?t.start:0,o=null!=t.end?t.end:i.length,0===o)return t.startCorrected=0,t.endCorrected=0,void 0;for(l=0,n=0;null==h||null==s;)a=d[l],e=i[n],a===e&&(n===r&&(h=l),n++,n===o&&(s=l+1)),l++;return t.startCorrected=h,t.endCorrected=s,null},t.prototype.getNodeContent=function(t,e){return null==e&&(e=!0),this.getNodeSelectionText(t,e)},t.prototype.collectPositions=function(t,e,o,n,r){var i,a,s,l,h,d,c,u,p,f,g,m,N,S;if(null==o&&(o=null),null==n&&(n=0),null==r&&(r=0),g=this.path[e],h=null!=g?g.content:void 0,null==h||""===h)return g.start=n+r,g.end=n+r,g.atomic=!1,r;if(N=null!=o?o.indexOf(h,r):r,-1===N)return r;if(d=N+h.length,i=!t.hasChildNodes(),g.start=n+N,g.end=n+d,g.atomic=i,!i)for(l=t.childNodes,c=0,m=0,S={};l.length>c;)a=l[c],p=this.getProperNodeName(a),f=S[p],u=null!=f?f+1:1,S[p]=u,s=e+"/"+p+(u>1?"["+u+"]":""),m=this.collectPositions(a,s,h,n+N,m),c++;return d},s=/^\s*$/,t.prototype.isWhitespace=function(t){return t.nodeType===Node.TEXT_NODE&&s.test(t.data)},t}()}).call(this);
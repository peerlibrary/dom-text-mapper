(function(){window.DomTextMapper=function(){function t(){this.setRealRoot(),window.DomTextMapper.instances.push(this)}var e,o,n,r,s,a,i,l;return i=!0,a=!0,s=!0,n=!0,r=!0,e=32,o=100,t.instances=[],t.changed=function(t,e){var o,n,r,s;if(null==e&&(e="no reason"),0!==this.instances.length){for(s=this.instances,n=0,r=s.length;r>n;n++)o=s[n],o.performUpdateOnNode(t);return null}},t.prototype.setRootNode=function(t){return this.rootWin=window,this.pathStartNode=this.rootNode=t},t.prototype.setRootId=function(t){return this.setRootNode(document.getElementById(t))},t.prototype.setRootIframe=function(t){var e;if(e=window.document.getElementById(t),null==e)throw Error("Can't find iframe with specified ID!");if(this.rootWin=e.contentWindow,null==this.rootWin)throw Error("Can't access contents of the spefified iframe!");return this.rootNode=this.rootWin.document,this.pathStartNode=this.getBody()},t.prototype.getDefaultPath=function(){return this.getPathTo(this.pathStartNode)},t.prototype.setRealRoot=function(){return this.rootWin=window,this.rootNode=document,this.pathStartNode=this.getBody()},t.prototype.documentChanged=function(){return this.lastDOMChange=this.timestamp()},t.prototype.scan=function(t,e){var o,n,r,s=this;return this.domStableSince(this.lastScanned)&&e(this.path),n=this.timestamp(),this.path={},o=this.getDefaultPath(),r={node:this.pathStartNode,path:o},this.finishTraverse(r,t,function(){var t,r,a;return r=s.timestamp(),console.log("Phase I (Path traversal) took "+(r-n)+" ms."),t=s.path[o].node,s.collectPositions(t,o,null,0,0),s.lastScanned=s.timestamp(),s.corpus=s.path[o].content,a=s.timestamp(),console.log("Phase II (offset calculation) took "+(a-r)+" ms."),e(s.path)}),null},t.prototype.selectPath=function(t,e){var o,n;if(null==e&&(e=!1),o=this.path[t],null==o)throw Error("I have no info about a node at "+t);return n=null!=o?o.node:void 0,n||(n=this.lookUpNode(o.path)),this.selectNode(n,e)},t.prototype.performUpdateOnNode=function(t,e){var o,n,r,s,a,i,l,h,d,u,c,p,g,f=this;if(null==e&&(e=!1),null==t)throw Error("Called performUpdate with a null node!");if(null!=this.path){if(d=this.timestamp(),e||this.saveSelection(),a=this.getPathTo(t),i=this.path[a],null==i)return this.performUpdateOnNode(t.parentNode,!0),e||this.restoreSelection(),void 0;if(i.node===t&&i.content===this.getNodeContent(t,!1)){h=a+"/",l=n,l=[],g=this.path;for(n in g)o=g[n],this.stringStartsWith(n,h)&&l.push(n);for(c=0,p=l.length;p>c;c++)n=l[c],delete this.path[n];u={path:a,node:t},this.finishTraverse(u,null,function(){var e,o,n;if(i.node===f.pathStartNode)return console.log("Ended up rescanning the whole doc."),f.collectPositions(t,a,null,0,0);if(o=f.parentPath(a),n=f.path[o],null==n)throw Error("While performing update on node "+a+", no path info found for parent path: "+o);return e=t===t.parentNode.firstChild?0:f.path[f.getPathTo(t.previousSibling)].end-n.start,f.collectPositions(t,a,n.content,n.start,e)})}else{if(i.node===this.pathStartNode)throw Error("Can not keep up with the changes, since even the node configured as path start node was replaced.");r=null!=t.parentNode?t.parentNode:(s=this.parentPath(a),this.lookUpNode(s)),this.performUpdateOnNode(r,!0)}return e?void 0:this.restoreSelection()}},t.prototype.getInfoForPath=function(t){var e;if(null==this.path)throw Error("Can't get info before running a scan() !");if(e=this.path[t],null==e)throw Error("Found no info for path '"+t+"'!");return e},t.prototype.getInfoForNode=function(t){return this.getInfoForPath(this.getPathTo(t))},t.prototype.getMappingsForCharRanges=function(t){var e,o,n,r,s;for(s=[],n=0,r=t.length;r>n;n++)e=t[n],s.push(o=this.getMappingsForCharRange(e.start,e.end));return s},t.prototype.getContentForPath=function(t){return null==t&&(t=null),null==t&&(t=this.getDefaultPath()),this.path[t].content},t.prototype.getLengthForPath=function(t){return null==t&&(t=null),null==t&&(t=this.getDefaultPath()),this.path[t].length},t.prototype.getDocLength=function(){return this.getLengthForPath()},t.prototype.getContentForCharRange=function(t,e,o){var n;return null==o&&(o=null),n=this.getContentForPath(o).substr(t,e-t),n.trim()},t.prototype.getContextForCharRange=function(t,o,n){var r,s,a,i,l;return null==n&&(n=null),r=this.getContentForPath(n),i=Math.max(0,t-e),a=t-i,s=r.substr(i,a),l=r.substr(o,a),[s.trim(),l.trim()]},t.prototype.getMappingsForCharRange=function(t,e){var o,n,r,s,a,i,l,h,d,u,c,p,g,f,m,v,N=this;if(null==t||null==e)throw Error("start and end is required!");if(!this.domStableSince(this.lastScanned))throw Error("Can not get mappings, since the dom has changed since last scanned. Call scan first.");l=[],v=this.path;for(h in v)i=v[h],i.atomic&&this.regions_overlap(i.start,i.end,t,e)&&function(o){var n,r;return r={element:o},n=o.start>=t&&e>=o.end,n?(r.full=!0,r.wanted=o.content,r.yields=o.content,r.startCorrected=0,r.endCorrected=0):o.node.nodeType===Node.TEXT_NODE?(o.start>=t?(r.end=e-o.start,r.wanted=o.content.substr(0,r.end)):e>=o.end?(r.start=t-o.start,r.wanted=o.content.substr(r.start)):(r.start=t-o.start,r.end=e-o.start,r.wanted=o.content.substr(r.start,r.end-r.start)),N.computeSourcePositions(r),r.yields=o.node.data.substr(r.startCorrected,r.endCorrected-r.startCorrected)):o.node.nodeType===Node.ELEMENT_NODE&&"img"===o.node.tagName.toLowerCase()?(console.log("Can not select a sub-string from the title of an image. Selecting all."),r.full=!0,r.wanted=o.content):(console.log("Warning: no idea how to handle partial mappings for node type "+o.node.nodeType),null!=o.node.tagName&&console.log("Tag: "+o.node.tagName),console.log("Selecting all."),r.full=!0,r.wanted=o.content),l.push(r)}(i);if(0===l.length)throw Error("No mappings found for ["+t+":"+e+"]!");return d=this.rootWin.document.createRange(),p=l[0],g=p.element.node,m=p.element.path,f=p.startCorrected,p.full?(d.setStartBefore(g),c=m):(d.setStart(g,f),c=m+":"+f),n=l[l.length-1],r=n.element.node,a=n.element.path,s=n.endCorrected,n.full?(d.setEndAfter(r),o=a):(d.setEnd(r,s),o=a+":"+s),u={mappings:l,realRange:d,rangeInfo:{startPath:m,startOffset:f,startInfo:c,endPath:a,endOffset:s,endInfo:o},safeParent:d.commonAncestorContainer}},t.prototype.timestamp=function(){return(new Date).getTime()},t.prototype.stringStartsWith=function(t,e){return e===t.substr(0,e.length)},t.prototype.stringEndsWith=function(t,e){return e===t.substr(t.length-e.length)},t.prototype.parentPath=function(t){return t.substr(0,t.lastIndexOf("/"))},t.prototype.domChangedSince=function(t){return null!=this.lastDOMChange&&null!=t?this.lastDOMChange>t:!0},t.prototype.domStableSince=function(t){return!this.domChangedSince(t)},t.prototype.getProperNodeName=function(t){var e;switch(e=t.nodeName){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return e}},t.prototype.getNodePosition=function(t){var e,o;for(e=0,o=t;o;)o.nodeName===t.nodeName&&e++,o=o.previousSibling;return e},t.prototype.getPathSegment=function(t){var e,o;return e=this.getProperNodeName(t),o=this.getNodePosition(t),e+(o>1?"["+o+"]":"")},t.prototype.getPathTo=function(t){var e;for(e="";t!==this.rootNode;)e=this.getPathSegment(t)+"/"+e,t=t.parentNode;return e=(null!=this.rootNode.ownerDocument?"./":"/")+e,e=e.replace(/\/$/,"")},t.prototype.executeTraverseTask=function(t){var e,o,n,r,s,a,i,l,h,d,u,c;if(s=t.node,a=t.path,n=null!=(d=t.invisible)?d:!1,i=null!=(u=t.verbose)?u:!1,o=this.getNodeContent(s,!1),this.path[a]={path:a,content:o,length:o.length,node:s},o.length?(i&&console.log("Collected info about path "+a),r&&console.log("Something seems to be wrong. I see visible content @ "+a+", while some of the ancestor nodes reported empty contents. Probably a new selection API bug....")):(i&&console.log("Found no content at path "+a),r=!0),s.hasChildNodes())for(c=s.childNodes,l=0,h=c.length;h>l;l++)e=c[l],this.traverseTasks.push({node:e,path:a+"/"+this.getPathSegment(e),invisible:r,verbose:i});return null},t.prototype.runTraverseRounds=function(t){var e,n,r,s;try{for(t.saveSelection(),n=t.timestamp(),s=0;t.traverseTasks.length&&o>t.timestamp()-n;)r=t.traverseTasks.pop(),t.executeTraverseTask(r),s+=1,r.node.hasChildNodes()||(t.traverseCoveredChars+=t.path[r.path].length);return t.restoreSelection(),null!=t.traverseOnProgress&&(e=t.traverseCoveredChars/t.traverseTotalLength,t.traverseOnProgress(e)),t.traverseTasks.length?window.setTimeout(t.runTraverseRounds,0,t):t.traverseOnFinished()}catch(a){return console.log("OOps. Internal error:"),console.log(a),console.log(a.stack)}},t.prototype.finishTraverse=function(t,e,o){if(null!=this.traverseTasks&&this.traverseTasks.size)throw Error("Error: a DOM traverse is already in progress!");return this.traverseTasks=[],this.saveSelection(),this.executeTraverseTask(t),this.restoreSelection(),this.traverseTotalLength=this.path[t.path].length,this.traverseOnProgress=e,this.traverseCoveredChars=0,this.traverseOnFinished=o,window.setTimeout(this.runTraverseRounds,0,this)},t.prototype.getBody=function(){return this.rootWin.document.getElementsByTagName("body")[0]},t.prototype.regions_overlap=function(t,e,o,n){return n>t&&e>o},t.prototype.lookUpNode=function(t){var e,o,n,r;return e=null!=(r=this.rootNode.ownerDocument)?r:this.rootNode,n=e.evaluate(t,this.rootNode,null,0,null),o=n.iterateNext()},t.prototype.saveSelection=function(){var t,e,o,n,r;if(null!=this.savedSelection)throw console.log("Selection saved at:"),console.log(this.selectionSaved),Error("Selection already saved!");for(e=this.rootWin.getSelection(),t=o=0,n=e.rangeCount;n>=0?n>o:o>n;t=n>=0?++o:--o)this.savedSelection=e.getRangeAt(t);switch(e.rangeCount){case 0:null==(r=this.savedSelection)&&(this.savedSelection=[]);break;case 1:this.savedSelection=[this.savedSelection]}try{throw Error("Selection was saved here")}catch(s){return this.selectionSaved=s.stack}},t.prototype.restoreSelection=function(){var t,e,o,n,r;if(null==this.savedSelection)throw Error("No selection to restore.");for(e=this.rootWin.getSelection(),e.removeAllRanges(),r=this.savedSelection,o=0,n=r.length;n>o;o++)t=r[o],e.addRange(t);return delete this.savedSelection},t.prototype.selectNode=function(t,e){var o,l,h,d,u;if(null==e&&(e=!1),h=this.rootWin.getSelection(),h.removeAllRanges(),l=this.rootWin.document.createRange(),t.nodeType===Node.ELEMENT_NODE&&t.hasChildNodes()&&(i&&("thead"===(u=t.tagName.toLowerCase())||"tbody"===u)||s&&"ol"===t.tagName.toLowerCase()||n&&"caption"===t.tagName.toLowerCase()))o=t.childNodes,l.setStartBefore(o[0]),l.setEndAfter(o[o.length-1]),h.addRange(l);else if(a&&t.nodeType===Node.TEXT_NODE&&"table"===t.parentNode.tagName.toLowerCase());else try{l.setStartBefore(t),l.setEndAfter(t),h.addRange(l)}catch(c){if(!r||!this.isWhitespace(t))throw c}if(e){for(d=t;null==d.scrollIntoViewIfNeeded;)d=d.parentNode;d.scrollIntoViewIfNeeded()}return h},t.prototype.readSelectionText=function(t){return t||(t=this.rootWin.getSelection()),(""+t).trim().replace(/\n/g," ").replace(/\s{2,}/g," ")},t.prototype.getNodeSelectionText=function(t,e){var o,n;return null==e&&(e=!0),e&&this.saveSelection(),o=this.selectNode(t),n=this.readSelectionText(o),e&&this.restoreSelection(),n},t.prototype.computeSourcePositions=function(t){var e,o,n,r,s,a,i,l,h,d;if(d=t.element.node.data.replace(/\n/g," "),s=t.element.content,r=null!=t.start?t.start:0,o=null!=t.end?t.end:s.length,0===o)return t.startCorrected=0,t.endCorrected=0,void 0;for(l=0,n=0;null==h||null==i;)a=d[l],e=s[n],a===e&&(n===r&&(h=l),n++,n===o&&(i=l+1)),l++;return t.startCorrected=h,t.endCorrected=i,null},t.prototype.getNodeContent=function(t,e){return null==e&&(e=!0),this.getNodeSelectionText(t,e)},t.prototype.collectPositions=function(t,e,o,n,r){var s,a,i,l,h,d,u,c,p,g,f,m,v,N;if(null==o&&(o=null),null==n&&(n=0),null==r&&(r=0),f=this.path[e],h=null!=f?f.content:void 0,null==h||""===h)return f.start=n+r,f.end=n+r,f.atomic=!1,r;if(v=null!=o?o.indexOf(h,r):r,-1===v)return r;if(d=v+h.length,s=!t.hasChildNodes(),f.start=n+v,f.end=n+d,f.atomic=s,!s)for(l=t.childNodes,u=0,m=0,N={};l.length>u;)a=l[u],p=this.getProperNodeName(a),g=N[p],c=null!=g?g+1:1,N[p]=c,i=e+"/"+p+(c>1?"["+c+"]":""),m=this.collectPositions(a,i,h,n+v,m),u++;return d},l=/^\s*$/,t.prototype.isWhitespace=function(t){return t.nodeType===Node.TEXT_NODE&&l.test(t.data)},t}()}).call(this);